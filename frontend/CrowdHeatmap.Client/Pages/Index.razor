@page "/"
@inject VideoService VideoService

<div class="page">

    <header class="header">
        <h1>Crowd Density Analysis</h1>
        <p>
            Upload a crowd surveillance video to analyze density patterns and generate
            a heatmap-based visualization using computer vision techniques.
        </p>
    </header>

    <section class="card upload-card">
        <h3>Video Upload</h3>
        <p class="hint">
            Supported formats: MP4, AVI. Processing time depends on video length.
        </p>

        <div class="upload-area">
            <InputFile OnChange="UploadVideo" />
        </div>

        @if (isLoading)
        {
            <div class="status loading">
                ⏳ Uploading and processing video...
            </div>
        }

        @if (errorMessage != null)
        {
            <div class="status error">
                ⚠️ @errorMessage
            </div>
        }
    </section>

    @if (originalUrl != null)
    {
        <section class="results">
            <div class="card video-card">
                <h4>Original Video</h4>
                <video src="@originalUrl" controls></video>
            </div>

            <div class="card video-card">
                <h4>Heatmap Output</h4>
                <video src="@heatmapUrl" controls></video>
            </div>
        </section>
    }

</div>

@code {
    string? originalUrl;
    string? heatmapUrl;
    string? errorMessage;
    bool isLoading = false;

    const string BackendBaseUrl = "http://localhost:8000";

    async Task UploadVideo(InputFileChangeEventArgs e)
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            var file = e.File;
            var result = await VideoService.UploadVideo(file);

            originalUrl = $"{BackendBaseUrl}{result.original}";
            heatmapUrl  = $"{BackendBaseUrl}{result.heatmap}";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}
